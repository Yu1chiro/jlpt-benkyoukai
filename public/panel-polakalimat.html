<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Pola Kalimat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    .prose .ql-container {
      border: none;
    }
    .prose .ql-editor {
      padding: 0;
    }
    .prose .ql-editor p {
      margin-top: 0;
      margin-bottom: 1em;
    }
    .prose .ql-editor ul,
    .prose .ql-editor ol {
      margin-top: 1em;
      margin-bottom: 1em;
    }
    .prose .ql-editor h1,
    .prose .ql-editor h2,
    .prose .ql-editor h3 {
      margin-bottom: 0.5em;
    }
  </style>

</head>
<body class="bg-stone-50 antialiased min-h-screen">

  <nav class="bg-white border-b border-stone-200 backdrop-blur-sm bg-white/90 sticky top-0 z-10">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-wrap justify-between items-center gap-4">
      <h1 id="panel-title" class="text-lg font-semibold text-stone-900 tracking-tight">Kelola Pola Kalimat</h1>
      <div class="flex items-center gap-3">
        <a href="/dashboard" class="text-sm font-medium text-stone-600 hover:text-stone-900 transition-colors duration-200">Kembali ke Dashboard</a>
        <a href="/api/logout" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-white bg-stone-900 hover:bg-stone-800 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2">Logout</a>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12 max-w-6xl">
    
    <div class="bg-white rounded-xl border border-stone-200 shadow-sm p-6 sm:p-8 mb-8">
      
      <h2 id="form-title" class="text-xl font-semibold text-stone-900 mb-6 tracking-tight">Tambah Pola Kalimat Baru</h2>
      
      <form id="add-grammar-form">
        <input type="hidden" id="editingId" value="">

        <div class="mb-6">
          <label for="pattern" class="block text-sm font-medium text-stone-700 mb-2">Pola Kalimat (cth: ～なければならない)</label>
          <input type="text" id="pattern" name="pattern" class="w-full px-4 py-2.5 text-sm text-stone-900 bg-white border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-stone-900 focus:border-transparent transition-all duration-200 placeholder:text-stone-400" placeholder="Masukkan pola kalimat" required>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div>
            <label class="block text-sm font-medium text-stone-700 mb-2">Penjelasan</label>
            <div id="quill-explanation" class="bg-white rounded-lg border border-stone-300 [&_.ql-toolbar]:border-b [&_.ql-toolbar]:border-stone-200 [&_.ql-toolbar]:bg-stone-50/50 [&_.ql-toolbar]:rounded-t-lg [&_.ql-container]:border-none [&_.ql-container]:rounded-b-lg [&_.ql-editor]:min-h-[250px] [&_.ql-editor]:text-base [&_.ql-editor]:text-stone-900 [&_.ql-editor]:leading-relaxed"></div>
          </div>
          <div>
            <label class="block text-sm font-medium text-stone-700 mb-2">Contoh Penggunaan</label>
            <div id="quill-example" class="bg-white rounded-lg border border-stone-300 [&_.ql-toolbar]:border-b [&_.ql-toolbar]:border-stone-200 [&_.ql-toolbar]:bg-stone-50/50 [&_.ql-toolbar]:rounded-t-lg [&_.ql-container]:border-none [&_.ql-container]:rounded-b-lg [&_.ql-editor]:min-h-[250px] [&_.ql-editor]:text-base [&_.ql-editor]:text-stone-900 [&_.ql-editor]:leading-relaxed"></div>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
          <button type="submit" id="submit-button" class="relative z-10 inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-stone-900 hover:bg-stone-800 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2">
            Simpan Pola Kalimat
          </button>
          <button type="button" id="cancel-edit-button" class="hidden relative z-10 inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-stone-700 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2">
            Batal Edit
          </button>
        </div>
      </form>
    </div>
    
    <div class="bg-white rounded-xl border border-stone-200 shadow-sm p-6 sm:p-8">
      <h2 class="text-xl font-semibold text-stone-900 mb-6 tracking-tight">Daftar Pola Kalimat</h2>
      <div id="grammar-list" class="space-y-4">
        <p class="text-sm text-stone-500">Memuat...</p>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const babId = urlParams.get('babId');
    const babTitle = urlParams.get('title');

    document.getElementById('panel-title').textContent = `Kelola Pola Kalimat: ${babTitle || ''}`;
    document.title = `Panel Pola Kalimat - ${babTitle || ''}`;

    const quillToolbarOptions = [
      [{ 'header': [1, 2, 3, false] }],
      ['bold', 'italic', 'underline'],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      ['clean']
    ];

    const quillExplanation = new Quill('#quill-explanation', {
      theme: 'snow',
      modules: { toolbar: quillToolbarOptions }
    });
    
    const quillExample = new Quill('#quill-example', {
      theme: 'snow',
      modules: { toolbar: quillToolbarOptions }
    });

    const form = document.getElementById('add-grammar-form');
    const listContainer = document.getElementById('grammar-list');

    // 4. Ambil Elemen UI Form
    const formTitle = document.getElementById('form-title');
    const submitButton = document.getElementById('submit-button');
    const cancelEditButton = document.getElementById('cancel-edit-button');
    const editingIdInput = document.getElementById('editingId');


    const showToast = (message, icon = 'success') => {
      Swal.fire({
        toast: true,
        position: 'top-end',
        icon: icon,
        title: message,
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true
      });
    };

    async function fetchGrammar() {
      if (!babId) {
        listContainer.innerHTML = '<p class="text-sm text-red-600">ID Bab tidak ditemukan.</p>';
        return;
      }
      try {
        const res = await fetch(`/api/grammar/${babId}`);
        const data = await res.json();
        listContainer.innerHTML = '';
        if (data.length === 0) {
          listContainer.innerHTML = '<p class="text-sm text-stone-500">Belum ada pola kalimat.</p>';
          return;
        }
        data.forEach(g => {
          listContainer.innerHTML += `
            <div class="border border-stone-200 rounded-lg p-5 hover:border-stone-300 transition-colors duration-200">
              <h3 class="text-lg font-semibold text-stone-900 mb-4 tracking-tight">${g.pattern}</h3>
              <div class="space-y-4">
                <div>
                  <h4 class="text-xs font-medium text-stone-500 uppercase tracking-wide mb-2">Penjelasan</h4>
                  <div class="prose prose-stone prose-sm max-w-none [&_.ql-editor]:text-sm [&_.ql-editor]:leading-relaxed [&_.ql-editor]:text-stone-700">
                    <div class="ql-container">
                      <div class="ql-editor">${g.explanation || '<p class="text-stone-400 italic">Tidak ada penjelasan</p>'}</div>
                    </div>
                  </div>
                </div>
                <div>
                  <h4 class="text-xs font-medium text-stone-500 uppercase tracking-wide mb-2">Contoh</h4>
                  <div class="prose prose-stone prose-sm max-w-none [&_.ql-editor]:text-sm [&_.ql-editor]:leading-relaxed [&_.ql-editor]:text-stone-700">
                    <div class="ql-container">
                      <div class="ql-editor">${g.example || '<p class="text-stone-400 italic">Tidak ada contoh</p>'}</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-4 pt-4 border-t border-stone-100 flex justify-end gap-2">
                <button class="edit-btn inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white bg-stone-900 hover:bg-stone-800 rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-1" data-id="${g.id}">
                  Edit
                </button>
                <button class="delete-btn inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-1" data-id="${g.id}">
                  Hapus
                </button>
              </div>
            </div>
          `;
        });
      } catch (err) {
        listContainer.innerHTML = '<p class="text-sm text-red-600">Gagal memuat data.</p>';
      }
    }

    // 5. Modifikasi Event Listener Submit (Logic Upsert)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const pattern = form.pattern.value;
      const explanation = quillExplanation.root.innerHTML;
      const example = quillExample.root.innerHTML;
      const editingId = editingIdInput.value;
      const isEditing = !!editingId;
      
      if (!pattern) {
        showToast('Pola kalimat tidak boleh kosong!', 'warning');
        return;
      }
      
      if (explanation === '<p><br></p>' && example === '<p><br></p>') {
        showToast('Penjelasan atau Contoh tidak boleh kosong!', 'warning');
        return;
      }

      // Siapkan data, URL, dan Method
      const data = { pattern, explanation, example };
      if (!isEditing) {
        data.bab_id = babId; // Tambahkan bab_id hanya saat membuat baru (POST)
      }

      const url = isEditing ? `/api/grammar/${editingId}` : '/api/grammar';
      const method = isEditing ? 'PUT' : 'POST';

      try {
        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!res.ok) {
          throw new Error(isEditing ? 'Gagal memperbarui' : 'Gagal menyimpan');
        }

        resetForm(); // Panggil fungsi reset
        fetchGrammar();
        showToast(isEditing ? 'Pola kalimat berhasil diperbarui.' : 'Pola kalimat berhasil disimpan.');
      
      } catch (err) {
        showToast(err.message, 'error');
      }
    });

    listContainer.addEventListener('click', (e) => {
      const target = e.target.closest('button');
      if (!target) return;
      const id = target.dataset.id;
      if (target.classList.contains('delete-btn')) {
        deleteGrammar(id);
      } else if (target.classList.contains('edit-btn')) {
        // 6. Panggil fungsi 'editGrammar' yang baru
        editGrammar(id);
      }
    });

    function deleteGrammar(id) {
      Swal.fire({
        title: 'Anda yakin?',
        text: "Pola kalimat ini akan dihapus permanen.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        cancelButtonText: 'Batal',
        confirmButtonText: 'Ya, hapus!'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            const res = await fetch(`/api/grammar/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Gagal menghapus');
            fetchGrammar();
            showToast('Pola kalimat berhasil dihapus.');
            resetForm(); // Reset form jika item yg diedit dihapus
          } catch (err) {
            showToast(err.message, 'error');
          }
        }
      });
    }

    // 7. Ganti fungsi editGrammar (tidak pakai Swal Form)
    async function editGrammar(id) {
      try {
        const res = await fetch(`/api/grammar/entry/${id}`);
        if (!res.ok) throw new Error('Gagal mengambil data');
        const data = await res.json();
        
        // Isi form utama
        form.pattern.value = data.pattern;
        quillExplanation.root.innerHTML = data.explanation;
        quillExample.root.innerHTML = data.example;
        editingIdInput.value = data.id;

        // Ubah UI form
        formTitle.textContent = 'Edit Pola Kalimat';
        submitButton.textContent = 'Simpan Perubahan';
        cancelEditButton.classList.remove('hidden');

        // Scroll ke atas
        window.scrollTo({ top: 0, behavior: 'smooth' });
        form.pattern.focus();
        
      } catch (err) {
        showToast(err.message, 'error');
      }
    }

    // 8. Buat fungsi resetForm
    function resetForm() {
      form.reset(); // Ini akan mengosongkan input 'pattern'
      quillExplanation.root.innerHTML = '';
      quillExample.root.innerHTML = '';
      editingIdInput.value = '';

      // Kembalikan UI ke state "Tambah"
      formTitle.textContent = 'Tambah Pola Kalimat Baru';
      submitButton.textContent = 'Simpan Pola Kalimat';
      cancelEditButton.classList.add('hidden');
    }

    // 9. Tambahkan listener untuk tombol Batal
    cancelEditButton.addEventListener('click', resetForm);

    document.addEventListener('DOMContentLoaded', fetchGrammar);
  </script>
</body>
</html>