<!DOCTYPE html>
<html lang="id" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kuis JLPT</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous" referrerpolicy="no-referrer" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho+B1&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />

  <script>
      tailwind.config = {
          darkMode: 'class',
      }
  </script>
  <style>
    /* [BARU] Terapkan font default agar konsisten */
    body {
      font-family: "Shippori Mincho B1", serif !important;
      font-weight: 400;
      font-style: normal;
    }
    .ql-container.ql-snow {
      border: none; /* Hapus border default quill */
    }
    .ql-editor {
      padding: 0; /* Hapus padding default quill */
      font-size: 1rem; /* Samakan dengan text-base tailwind */
      font-weight: 500; /* Samakan dengan font-medium tailwind */
      color: #292524; /* Samakan dengan text-stone-900 */
      line-height: 1.625; /* Samakan dengan leading-relaxed */
    }
    .ql-editor p {
      margin-bottom: 0; /* Hapus margin default paragraf */
    }

    /* [BARU] Style Quill untuk Dark Mode */
    .dark .ql-editor {
        color: #f5f5f4; /* text-stone-100 */
    }
  </style>

</head>
<body class="bg-stone-50 dark:bg-stone-900 text-stone-900 dark:text-stone-100 min-h-screen antialiased transition-colors duration-200">
  
  <header class="bg-white/90 dark:bg-stone-800/90 border-b border-stone-200 dark:border-stone-700 sticky top-0 z-10 backdrop-blur-sm">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center gap-4">
      <a href="#" id="back-to" class="text-sm font-medium text-stone-600 dark:text-stone-400 hover:text-stone-900 dark:hover:text-stone-100 transition-colors duration-200 flex items-center gap-2 group">
        <span class="transform group-hover:-translate-x-1 transition-transform duration-200">&larr;</span>
        <span>クイズ</span>
      </a>
      
      <div class="flex items-center gap-4">
        <h2 id="chapter-title" class="text-sm font-medium text-stone-500 dark:text-stone-400 text-right truncate max-w-xs sm:max-w-md">Kuis</h2>
        
        <button id="theme-toggle-btn"
            class="relative w-12 h-12 p-2 text-stone-600 dark:text-stone-400 hover:text-stone-900 dark:hover:text-stone-100 transition-colors duration-200 rounded-full hover:bg-stone-200 dark:hover:bg-stone-700 focus:outline-none focus:ring-2 focus:ring-stone-900 dark:focus:ring-stone-100 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-stone-800">
            <span class="sr-only">Toggle theme</span>
            <i id="sun-icon" class="fa-solid fa-sun text-xl absolute inset-0 m-auto"></i>
            <i id="moon-icon" class="fa-solid fa-moon text-xl absolute inset-0 m-auto"></i>
        </button>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
    <div id="quiz-container" class="bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-lg p-6 md:p-8 max-w-3xl mx-auto">
      
      <div id="loading" class="text-center py-8">
        <p class="text-sm text-stone-500 dark:text-stone-400">Memuat kuis...</p>
      </div>
      
      <form id="quiz-form" class="hidden">
      </form>
      
      <div id="result-container" class="hidden text-center py-4">
        <h2 class="text-2xl font-semibold text-stone-900 dark:text-stone-100 mb-6 tracking-tight">Hasil Kuis Anda</h2>
        <p class="text-6xl font-bold mb-4 tracking-tight" id="score-text">0%</p>
        <p class="text-sm text-stone-600 dark:text-stone-400 mb-8" id="score-details">Anda benar 0 dari 0 soal.</p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <button onclick="window.location.reload()" class="inline-flex items-center justify-center px-6 py-3 text-sm font-medium text-stone-900 dark:text-stone-100 bg-white dark:bg-stone-700 border border-stone-300 dark:border-stone-600 hover:bg-stone-50 dark:hover:bg-stone-600 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 dark:focus:ring-stone-100 focus:ring-offset-2 dark:focus:ring-offset-stone-800">
            Coba Lagi
          </button>
          <a id="back-to-study" href="#" class="inline-flex items-center justify-center px-6 py-3 text-sm font-medium text-white dark:text-stone-900 bg-stone-900 dark:bg-stone-100 hover:bg-stone-800 dark:hover:bg-stone-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 dark:focus:ring-stone-100 focus:ring-offset-2 dark:focus:ring-offset-stone-800">
            Kembali Belajar
          </a>
        </div>
      </div>
    </div>
  </main>
<script>
      (function() {
          try {
              const theme = localStorage.getItem('theme');
              const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
              
              if (theme === 'dark' || (!theme && prefersDark)) {
                  document.documentElement.classList.add('dark');
              } else {
                  document.documentElement.classList.remove('dark');
              }
          } catch (err) {}
      })();
  </script>
  <script>
  const urlParams = new URLSearchParams(window.location.search);
  const babId = urlParams.get('babId');

  const loadingEl = document.getElementById('loading');
  const quizForm = document.getElementById('quiz-form');
  const resultContainer = document.getElementById('result-container');
  const scoreText = document.getElementById('score-text');
  const scoreDetails = document.getElementById('score-details');
  const backToStudy = document.getElementById('back-to-study');
  const backTo = document.getElementById('back-to');
  
  let questions = [];

  if (!babId) {
      // (Pesan error tidak perlu dark mode, sudah merah)
      loadingEl.innerHTML = '<p class="text-sm text-red-600 font-medium mb-2">Error: ID Bab tidak valid.</p><a href="/" class="text-sm text-stone-900 dark:text-stone-100 hover:text-stone-700 dark:hover:text-stone-300 underline">Kembali ke Home</a>';
  } else {
    backToStudy.href = `/study?babId=${babId}`;
    backTo.href = `/study?babId=${babId}`;

    async function fetchQuiz() {
      try {
        const res = await fetch(`/api/quizzes/${babId}`);
        if (!res.ok) throw new Error('Gagal mengambil data kuis.');
        
        questions = await res.json();
        
        if (questions.length === 0) {
          loadingEl.textContent = 'Belum ada kuis untuk bab ini.';
          loadingEl.classList.add('text-stone-500', 'dark:text-stone-400'); // [MODIFIKASI]
          return;
        }

        renderQuiz();
      } catch (err) {
        console.error('Error fetching quiz:', err);
        loadingEl.textContent = 'Gagal memuat kuis.';
        loadingEl.classList.add('text-red-600'); // (Merah sudah OK)
      }
    }

    // 3. Modifikasi fungsi renderQuiz
    function renderQuiz() {
      loadingEl.classList.add('hidden');
      quizForm.classList.remove('hidden');
      
      let quizHTML = '';
      questions.forEach((q, index) => {
        // [MODIFIKASI] class dark-mode ditambahkan
        quizHTML += `
          <div class="mb-8 pb-8 border-b border-stone-100 dark:border-stone-700 last:border-b-0">
            <div class="flex items-start mb-4">
              <span class="text-base font-medium text-stone-900 dark:text-stone-100 mr-2 shrink-0">${index + 1}.</span>
              <div class="ql-container ql-snow grow">
                <div class="ql-editor">${q.question}</div>
              </div>
            </div>
            <div class="space-y-2 mt-5 pl-6">
              ${renderOption(q.id, 'A', q.option_a)}
              ${renderOption(q.id, 'B', q.option_b)}
              ${renderOption(q.id, 'C', q.option_c)}
              ${renderOption(q.id, 'D', q.option_d)}
            </div>
          </div>
        `;
      });

      // [MODIFIKASI] class dark-mode ditambahkan (tombol utama)
      quizHTML += '<button type="submit" class="w-full bg-stone-900 dark:bg-stone-100 hover:bg-stone-800 dark:hover:bg-stone-200 text-white dark:text-stone-900 font-medium py-3 px-6 rounded-lg text-sm transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 dark:focus:ring-stone-100 focus:ring-offset-2 dark:focus:ring-offset-stone-800">Submit Jawaban</button>';
      quizForm.innerHTML = quizHTML;
    }

    function renderOption(questionId, optionLetter, optionText) {
      // [MODIFIKASI] class dark-mode ditambahkan
      return `
        <div>
          <label class="flex items-start p-4 rounded-lg border border-stone-200 dark:border-stone-700 hover:border-stone-300 dark:hover:border-stone-500 hover:bg-stone-50 dark:hover:bg-stone-700 cursor-pointer transition-all duration-200 group">
            <input type="radio" name="question_${questionId}" value="${optionLetter}" class="mt-0.5 mr-3 text-stone-900 dark:text-stone-100 focus:ring-stone-900 dark:focus:ring-stone-100 focus:ring-offset-0" required>
            <span class="text-sm text-stone-700 dark:text-stone-300 group-hover:text-stone-900 dark:group-hover:text-stone-100 transition-colors duration-200">${optionLetter}. ${optionText}</span>
          </label>
        </div>
      `;
    }

    quizForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const userAnswers = [];
      questions.forEach(q => {
          const selected = quizForm.querySelector(`input[name="question_${q.id}"]:checked`);
        userAnswers.push({
          questionId: q.id,
          answer: selected ? selected.value : null
        });
      });

      try {
        const res = await fetch(`/api/submit-quiz/${babId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers: userAnswers })
        });
        
        if (!res.ok) throw new Error('Gagal mengirimkan jawaban.');
        
        const result = await res.json();
        showResults(result);

      } catch (err) {
        console.error('Error submitting quiz:', err);
        alert('Gagal mensubmit kuis. Silakan coba lagi.');
      }
    });

    function showResults(result) {
      quizForm.classList.add('hidden');
      resultContainer.classList.remove('hidden');

      const percentage = (result.score / result.total) * 100;
      scoreText.textContent = `${percentage.toFixed(0)}%`;
      scoreDetails.textContent = `Anda benar ${result.score} dari ${result.total} soal.`;

      // (Warna skor tidak perlu diubah, sudah bagus di light/dark mode)
      scoreText.classList.remove('text-green-600', 'text-amber-600', 'text-red-600');
      if (percentage >= 80) {
        scoreText.classList.add('text-green-600');
      } else if (percentage >= 50) {
        scoreText.classList.add('text-amber-600');
      } else {
        scoreText.classList.add('text-red-600');
      }
    }

    document.addEventListener('DOMContentLoaded', fetchQuiz);
  }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const htmlEl = document.documentElement;

        function animateIcons(isDark) {
            if (isDark) {
                gsap.to(sunIcon, { rotation: 90, scale: 0, opacity: 0, duration: 0.3, ease: "power1.in" });
                gsap.fromTo(moonIcon,
                    { rotation: -90, scale: 0, opacity: 0 },
                    { rotation: 0, scale: 1, opacity: 1, duration: 0.3, ease: "power1.out", delay: 0.1 }
                );
            } else {
                gsap.to(moonIcon, { rotation: 90, scale: 0, opacity: 0, duration: 0.3, ease: "power1.in" });
                gsap.fromTo(sunIcon,
                    { rotation: -90, scale: 0, opacity: 0 },
                    { rotation: 0, scale: 1, opacity: 1, duration: 0.3, ease: "power1.out", delay: 0.1 }
                );
            }
        }

        function setInitialIconState() {
            if (htmlEl.classList.contains('dark')) {
                gsap.set(sunIcon, { scale: 0, opacity: 0, rotation: 90 });
                gsap.set(moonIcon, { scale: 1, opacity: 1, rotation: 0 });
            } else {
                gsap.set(sunIcon, { scale: 1, opacity: 1, rotation: 0 });
                gsap.set(moonIcon, { scale: 0, opacity: 0, rotation: -90 });
            }
        }

        setInitialIconState();

        themeToggleBtn.addEventListener('click', () => {
            const isCurrentlyDark = htmlEl.classList.contains('dark');

            if (isCurrentlyDark) {
                htmlEl.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                animateIcons(false);
            } else {
                htmlEl.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                animateIcons(true);
            }
        });

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
                if (e.matches) {
                    htmlEl.classList.add('dark');
                    animateIcons(true);
                } else {
                    htmlEl.classList.remove('dark');
                    animateIcons(false);
                }
            }
        });
    });
  </script>

</body>
</html>